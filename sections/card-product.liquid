{{ 'section-card-product.css' | asset_url | stylesheet_tag }}

<div class="section-card-product">
  <div class="page-width">
    <div class="row">
      {% for block in section.blocks %}
        {% assign products = block.settings.product_item %}
        {% if products != blank %}
          {% for product in products %}
            <div class="col-3" {{ block.shopify_attributes }}>
              <div class="product_card">
                <div class="product_block">
                  <a href="{{ product.url }}">
                    <img
                      src="{{ product.featured_image | image_url: width: 400 }}"
                      alt="{{ product.title }}"
                      loading="lazy"
                    >
                  </a>
                </div>

                <div class="product_content">
                  <h3>{{ product.title }}</h3>
                  <div class="price">{{ product.price | money }}</div>

                 <div class="quick-add no-js-hidden">
                    {%- liquid
                      assign qty_rules = false
                      if card_product.selected_or_first_available_variant.quantity_rule.min > 1 or card_product.selected_or_first_available_variant.quantity_rule.max != null or card_product.selected_or_first_available_variant.quantity_rule.increment > 1
                        assign qty_rules = true
                      endif
                    -%}
                    {%- if card_product.variants_count > 1 or qty_rules -%}
                      <modal-opener data-modal="#QuickAdd-{{ card_product.id }}">
                        <button
                          id="{{ product_form_id }}-submit"
                          type="submit"
                          name="add"
                          class="quick-add__submit button button--full-width button--secondary{% if horizontal_quick_add %} card--horizontal__quick-add animate-arrow{% endif %}"
                          aria-haspopup="dialog"
                          aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
                          data-product-url="{{ card_product.url }}"
                        >
                          {{ 'products.product.choose_options' | t }}
                          {%- if horizontal_quick_add -%}
                            <span class="icon-wrap">
                              {{- 'icon-arrow.svg' | inline_asset_content -}}
                            </span>
                          {%- endif -%}
                          {%- render 'loading-spinner' -%}
                        </button>
                      </modal-opener>
                      <quick-add-modal id="QuickAdd-{{ card_product.id }}" class="quick-add-modal">
                        <div
                          role="dialog"
                          aria-label="{{ 'products.product.choose_product_options' | t: product_name: card_product.title | escape }}"
                          aria-modal="true"
                          class="quick-add-modal__content global-settings-popup"
                          tabindex="-1"
                        >
                          <button
                            id="ModalClose-{{ card_product.id }}"
                            type="button"
                            class="quick-add-modal__toggle"
                            aria-label="{{ 'accessibility.close' | t }}"
                          >
                            {{- 'icon-close.svg' | inline_asset_content -}}
                          </button>
                          <div id="QuickAddInfo-{{ card_product.id }}" class="quick-add-modal__content-info"></div>
                        </div>
                      </quick-add-modal>
                    {%- else -%}
                      <product-form data-section-id="{{ section.id }}">
                        {%- form 'product',
                          card_product,
                          id: product_form_id,
                          class: 'form',
                          novalidate: 'novalidate',
                          data-type: 'add-to-cart-form'
                        -%}
                          <input
                            type="hidden"
                            name="id"
                            value="{{ card_product.selected_or_first_available_variant.id }}"
                            class="product-variant-id"
                            {% if card_product.selected_or_first_available_variant.available == false %}
                              disabled
                            {% endif %}
                          >
                          <button
                            id="{{ product_form_id }}-submit"
                            type="submit"
                            name="add"
                            class="quick-add__submit button button--full-width button--secondary{% if horizontal_quick_add %} card--horizontal__quick-add{% endif %}"
                            aria-haspopup="dialog"
                            aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
                            aria-live="polite"
                            data-sold-out-message="true"
                            {% if card_product.selected_or_first_available_variant.available == false %}
                              disabled
                            {% endif %}
                          >
                            <span>
                              {%- if card_product.selected_or_first_available_variant.available -%}
                                {{ 'products.product.add_to_cart' | t }}
                              {%- else -%}
                                {{ 'products.product.sold_out' | t }}
                              {%- endif -%}
                            </span>
                            <span class="sold-out-message hidden">
                              {{ 'products.product.sold_out' | t }}
                            </span>
                            {%- if horizontal_quick_add -%}
                              <span class="icon-wrap">
                                {{- 'icon-plus.svg' | inline_asset_content -}}
                              </span>
                            {%- endif -%}
                            {%- render 'loading-spinner' -%}
                          </button>
                        {%- endform -%}
                      </product-form>
                    {%- endif -%}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        {% endif %}
      {% endfor %}
    </div>
  </div>
</div>

<script>
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.custom-atc-btn');
    if (!btn) return;

    e.preventDefault();

    const variantId = btn.dataset.variantId;
    if (!variantId) return;

    fetch('/cart/add.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Accept: 'application/json',
      },
      body: JSON.stringify({
        id: variantId,
        quantity: 1,
      }),
    })
      .then((response) => response.json())
      .then(() => {
        // ðŸ”¥ THIS IS THE KEY LINE (Shopify native drawer trigger)
        document.dispatchEvent(new Event('cart:refresh'));
      })
      .catch((error) => console.error('ATC error:', error));
  });
</script>

{% schema %}
{
  "name": "Custom Product Cards",
  "settings": [],
  "blocks": [
    {
      "type": "product",
      "name": "Product Card",
      "settings": [
        {
          "type": "product_list",
          "id": "product_item",
          "label": "Select product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Custom Product Cards"
    }
  ]
}
{% endschema %}
